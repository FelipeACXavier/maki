name: Release

on:
  push:
    tags:
      # Stable releases: v1.2.3
      - 'v[0-9]+.[0-9]+.[0-9]+'
      # Pre-releases: v1.2.3-rc1, v1.2.3-beta, etc.
      - 'v[0-9]+.[0-9]+.[0-9]+-*'

jobs:
  # 1) Build Linux + Windows artifacts inside dev image
  build:
    runs-on: self-hosted
    container:
      image: ghcr.io/${{ github.repository }}/dev:${{ vars.QT_DEV_TAG }}

    strategy:
      matrix:
        target: [ linux, windows ]

    env:
      BUILD_TARGET: ${{ matrix.target }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build release artifacts
        # scripts/release-build.sh must create:
        #   dist/linux/... for BUILD_TARGET=linux
        #   dist/windows/... for BUILD_TARGET=windows
        run: |
          chmod +x scripts/release.sh
          ./scripts/release.sh "$BUILD_TARGET"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}-build
          path: dist/${{ matrix.target }}/

  # 2) Package Windows Qt SDK from inside the same dev image
  package-qt-sdk:
    runs-on: self-hosted
    container:
      image: ghcr.io/${{ github.repository }}/dev:${{ vars.QT_DEV_TAG }}

    steps:
      - name: Package Windows Qt SDK
        # Assumes /opt/qt-win64 is your Windows Qt install in the image
        run: |
          cd /home/ubuntu/Qt6-Windows
          zip -r "$GITHUB_WORKSPACE/qt-win64.zip" qt-win64

      - name: Upload Qt SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: qt-win64-sdk
          path: qt-win64.zip

  # 3) On Windows: run windeployqt using the SDK from the image, then create release
  package-and-release:
    runs-on: windows-latest
    needs:
      - build
      - package-qt-sdk

    steps:
      # --- Download artifacts from previous jobs ---
      - name: Download Linux build
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: dist/linux

      - name: Download Windows build
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: dist/windows

      - name: Download Qt SDK
        uses: actions/download-artifact@v4
        with:
          name: qt-win64-sdk
          path: qt-sdk

      # --- Unpack the Qt SDK into a portable directory ---
      - name: Unpack Qt SDK
        run: |
          Expand-Archive -Path "qt-sdk/qt-win64.zip" -DestinationPath "qt-sdk"

      # --- Add Qt's bin (where windeployqt.exe lives) to PATH ---
      - name: Add Qt to PATH
        run: echo "$PWD\qt-sdk\qt-win64\bin" >> $env:GITHUB_PATH

      # --- Run windeployqt on your built Windows exe ---
      - name: Run windeployqt
        run: |
          # Adjust path/exe name to your actual app
          windeployqt.exe "dist/windows/MyApp.exe"

      # --- Package final artifacts for release ---
      - name: Package Linux artifact
        run: |
          Compress-Archive -Path dist/linux -DestinationPath linux-release.zip

      - name: Package Windows artifact
        run: |
          Compress-Archive -Path dist/windows -DestinationPath windows-release.zip

      # --- Create GitHub Release with auto-changelog + prerelease detection ---
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            linux-release.zip
            windows-release.zip
          # Auto-generate notes from commits/PRs
          generate_release_notes: true
          # Mark as prerelease if tag has a "-" (e.g. v1.2.3-rc1)
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
