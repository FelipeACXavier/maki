name: Release

# Create release on tag creation, but only if it follows a specific pattern
on:
  push:
    tags:
      # Stable releases: v1.2.3
      - 'v[0-9]+.[0-9]+.[0-9]+'
      # Pre-releases: v1.2.3-rc1, v1.2.3-beta, etc.
      - 'v[0-9]+.[0-9]+.[0-9]+-*'

jobs:
  # ==========================================================================================
  # 1) Build Linux artifacts + Windows SDK inside the dev image
  build:
    name: Build (Linux + Windows SDK)
    runs-on: self-hosted
    container:
      image: ghcr.io/felipeacxavier/maki/dev:${{ vars.QT_DEV_TAG }}

    strategy:
      # Release both Linux and Windows targets inside this image
      matrix:
        target: [ linux, windows ]

    defaults:
      run:
        shell: bash
        working-directory: ~/maki

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          path: ~/maki

      # --------------------------------------------------------------------------------------
      # Create the package
      - name: Build ${{ matrix.target }}
        run: |
          chmod +x scripts/build.sh
          ./scripts/build.sh "${{ matrix.target }}"

      - name: Create release for ${{ matrix.target }}
        run: |
          chmod +x ./scripts/release.sh
          ./scripts/release.sh "${{ matrix.target }}"

      - name: Package release for ${{ matrix.target }}
        run: |
          cd ./release/"$BUILD_TARGET"
          zip -r ../maki-${{ matrix.target }}.zip ./*

      # --------------------------------------------------------------------------------------
      # Upload artifact for next job
      - name: Upload ${{ matrix.target }} artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target }}
          path: release/maki-${{ matrix.target }}.zip

  # ==========================================================================================
  # 2) Publish GitHub Release
  release:
    name: Create GitHub Release
    needs: build
    runs-on: self-hosted

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux
          path: ./release

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: windows
          path: ./release

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ./release/maki-linux.zip
            ./release/maki-windows.zip
          generate_release_notes: true
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
