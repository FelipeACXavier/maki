name: Release

# Create release on tag creation, but only if it follows a specific pattern
on:
  push:
    tags:
      # Stable releases: v1.2.3
      - 'v[0-9]+.[0-9]+.[0-9]+'
      # Pre-releases: v1.2.3-rc1, v1.2.3-beta, etc.
      - 'v[0-9]+.[0-9]+.[0-9]+-*'

jobs:
  # ==========================================================================================
  # 1) Build Linux artifacts + Windows SDK inside the dev image
  build:
    name: Build (Linux + Windows SDK)
    runs-on: self-hosted
    container:
      image: ghcr.io/felipeacxavier/maki/dev:${{ vars.QT_DEV_TAG }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------------------------------------------------------------------------
      # Linux build
      - name: Build (Linux)
        run: |
          chmod +x scripts/build.sh
          ./scripts/build.sh --linux

      - name: Create Linux release
        run: |
          chmod +x ./scripts/release.sh
          ./scripts/release.sh --linux

      - name: Upload Linux release folder
        uses: actions/upload-artifact@v4
        with:
          name: linux-release-folder
          path: dist/linux

      # --------------------------------------------------------------------------------------
      # Windows build
      - name: Build (Windows cross)
        run: |
          chmod +x scripts/build.sh
          ./scripts/build.sh --windows

      - name: Package Windows SDK
        run: |
          chmod +x ./scripts/release.sh
          ./scripts/release.sh --windows

      - name: Upload Windows SDK
        uses: actions/upload-artifact@v4
        with:
          name: windows-sdk
          path: windows-sdk.zip

  # ==========================================================================================
  # 2) On Windows runner: create Windows release using SDK + re-zip Linux
  release:
    name: Create GitHub Release
    needs: build
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------------------------------------------------------------------------
      # Linux release
      - name: Download Linux release folder
        uses: actions/download-artifact@v4
        with:
          name: linux-release-folder
          path: artifacts/linux

      - name: Package Linux artifact
        run: |
          Compress-Archive -Path dist/linux -DestinationPath linux-release.zip

      # --------------------------------------------------------------------------------------
      # Windows release
      - name: Download Windows SDK
        uses: actions/download-artifact@v4
        with:
          name: windows-sdk
          path: artifacts

      - name: Unpack Windows SDK
        run: |
          Push-Location artifacts
          Expand-Archive -Path "windows-sdk.zip" -DestinationPath "."
          Pop-Location

      # Use SDK + windeployqt to create Windows release
      # - name: Create Windows release with windeployqt
      #   shell: pwsh
      #   run: |
      #     Set-StrictMode -Version Latest
      #     $ErrorActionPreference = "Stop"

      #     $sdkRoot   = (Resolve-Path "artifacts/windows-sdk").Path
      #     $qtTools   = Join-Path $sdkRoot "qttools-install/bin"
      #     $buildWin  = Join-Path $sdkRoot "build-windows"

      #     $exe       = Join-Path $buildWin "maki.exe"

      #     $distWin   = Join-Path $PWD "dist/windows"
      #     New-Item -ItemType Directory -Force -Path $distWin | Out-Null

      #     # Make sure windeployqt.exe is on PATH
      #     $env:PATH = "$qtTools;$env:PATH"

      #     $windeploy = Join-Path $qtTools "windeployqt.exe"

      #     $windeploy "--dir=$distWin" $exe

      #     if ($LASTEXITCODE -ne 0) {
      #       throw "windeployqt.exe failed with exit code $LASTEXITCODE"
      #     }

      - name: Package Windows artifact
        run: |
          Compress-Archive -Path windows-sdk -DestinationPath windows-release.zip

      # --------------------------------------------------------------------------------------
      # Publish GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            linux-release.zip
            windows-release.zip
          generate_release_notes: true
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
